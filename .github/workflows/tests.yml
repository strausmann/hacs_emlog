name: Tests

on:
  push:
    branches: [main]
    paths:
      - 'custom_components/emlog/**'
      - 'tests/**'
      - '.github/workflows/tests.yml'
  pull_request:
    branches: [main]
    paths:
      - 'custom_components/emlog/**'
      - 'tests/**'
      - '.github/workflows/tests.yml'

jobs:
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pylint mypy

      - name: Lint with pylint
        run: |
          # Prüfe Python-Dateien auf Syntaxfehler
          # Home Assistant Dependencies sind nicht verfügbar, aber Syntax wird geprüft
          pylint --errors-only custom_components/emlog/*.py 2>&1 | grep -v "E0401" || true
        continue-on-error: true

      - name: Type check with mypy
        run: |
          # mypy mit Home Assistant Stubs
          mypy custom_components/emlog/*.py --ignore-missing-imports \
            --disable-error-code=call-arg || true
        continue-on-error: true

  mock-server-test:
    name: Mock Server Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install mock server dependencies
        run: |
          pip install -r tests/mock/requirements.txt

      - name: Start mock server
        run: |
          python tests/mock/mock_server.py &
          sleep 3
        timeout-minutes: 1

      - name: Test API endpoints
        run: |
          python3 << 'EOF'
          import json
          import urllib.request
          import sys

          def validate_json_structure(data, meter_type):
              """Prüfe die erwartete JSON-Struktur"""
              required_keys = [
                  'Zaehlerstand_Bezug',
                  'Wirkleistung_Bezug',
                  'Kwh_Bezug',
                  'Betrag_Bezug',
                  'Betrag_Lieferung',
                  'DiffBezugLieferung',
                  'product',
                  'version'
              ]
              
              for key in required_keys:
                  if key not in data:
                      print(f"✗ {meter_type}: Missing key '{key}'")
                      return False
              
              # Prüfe Zaehlerstand_Bezug Struktur
              zaehler = data.get('Zaehlerstand_Bezug', {})
              if 'Stand180' not in zaehler:
                  print(f"✗ {meter_type}: Missing Stand180 in Zaehlerstand_Bezug")
                  return False
              
              # Prüfe Betrag_Bezug hat Waehrung
              betrag = data.get('Betrag_Bezug', {})
              if 'Waehrung' not in betrag:
                  print(f"✗ {meter_type}: Missing Waehrung in Betrag_Bezug")
                  return False
              
              print(f"✓ {meter_type} JSON structure is valid")
              return True

          try:
              # Test Strom (Index 1)
              with urllib.request.urlopen('http://localhost:8080/pages/getinformation.php?export&meterindex=1') as response:
                  data = json.loads(response.read().decode())
                  if not validate_json_structure(data, 'Strom'):
                      sys.exit(1)

              # Test Gas (Index 2)
              with urllib.request.urlopen('http://localhost:8080/pages/getinformation.php?export&meterindex=2') as response:
                  data = json.loads(response.read().decode())
                  if not validate_json_structure(data, 'Gas'):
                      sys.exit(1)

              # Test invalid endpoint
              try:
                  urllib.request.urlopen('http://localhost:8080/pages/getinformation.php')
                  print("✗ Error handling: Should have failed without export parameter")
                  sys.exit(1)
              except urllib.error.HTTPError as e:
                  if e.code == 400:
                      print("✓ Error handling works (400 Bad Request)")
                  else:
                      print(f"✗ Expected 400 but got {e.code}")
                      sys.exit(1)

          except Exception as e:
              print(f"✗ Test failed: {e}")
              sys.exit(1)
          EOF

  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build mock server Docker image
        run: |
          docker build -t emlog-mock:test tests/mock/

      - name: Test Docker image
        run: |
          docker run -d --name test-emlog -p 8080:8080 emlog-mock:test
          sleep 3
          curl -f http://localhost:8080/pages/getinformation.php?export\&meterindex=1 \
            | python -m json.tool > /dev/null
          echo "✓ Docker container works correctly"
        timeout-minutes: 2

      - name: Cleanup
        if: always()
        run: |
          docker stop test-emlog 2>/dev/null || true
          docker rm test-emlog 2>/dev/null || true

  manifest-validation:
    name: Manifest Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate manifest.json
        run: |
          python -c "
          import json
          with open('custom_components/emlog/manifest.json') as f:
              manifest = json.load(f)
              
          # Prüfe erforderliche Felder
          required = ['domain', 'name', 'codeowners', 'config_flow', 'documentation', 'version']
          for field in required:
              if field not in manifest:
                  print(f'✗ Missing required field: {field}')
                  exit(1)
          
          print('✓ Manifest has all required fields')
          print(f'✓ Version: {manifest[\"version\"]}')
          print(f'✓ Domain: {manifest[\"domain\"]}')
          "

  import-check:
    name: Import Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check imports
        run: |
          python -c "
          import sys
          import ast
          
          files = [
              'custom_components/emlog/__init__.py',
              'custom_components/emlog/config_flow.py',
              'custom_components/emlog/coordinator.py',
              'custom_components/emlog/sensor.py',
              'custom_components/emlog/template.py',
          ]
          
          for file in files:
              with open(file) as f:
                  try:
                      ast.parse(f.read())
                      print(f'✓ {file}: Syntax OK')
                  except SyntaxError as e:
                      print(f'✗ {file}: Syntax error at line {e.lineno}')
                      print(f'  {e.msg}')
                      sys.exit(1)
          "
