name: Tests

on:
  push:
    branches: [main]
    paths:
      - 'custom_components/emlog/**'
      - 'tests/**'
      - '.github/workflows/tests.yml'
  pull_request:
    branches: [main]
    paths:
      - 'custom_components/emlog/**'
      - 'tests/**'
      - '.github/workflows/tests.yml'

jobs:
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pylint mypy

      - name: Lint with pylint
        run: |
          # Prüfe Python-Dateien auf Syntaxfehler
          pylint --errors-only custom_components/emlog/*.py
        continue-on-error: true

      - name: Type check with mypy
        run: |
          mypy custom_components/emlog/*.py --ignore-missing-imports
        continue-on-error: true

  mock-server-test:
    name: Mock Server Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install mock server dependencies
        run: |
          pip install -r tests/mock/requirements.txt

      - name: Start mock server
        run: |
          python tests/mock/mock_server.py &
          sleep 3
        timeout-minutes: 1

      - name: Test API endpoints
        run: |
          # Test Strom (Index 1)
          curl -f http://localhost:8080/pages/getinformation.php?export\&meterindex=1 \
            | python -m json.tool > /dev/null || exit 1
          echo "✓ Strom API endpoint works"

          # Test Gas (Index 2)
          curl -f http://localhost:8080/pages/getinformation.php?export\&meterindex=2 \
            | python -m json.tool > /dev/null || exit 1
          echo "✓ Gas API endpoint works"

          # Test invalid endpoint (sollte 400 zurückgeben)
          curl -s http://localhost:8080/pages/getinformation.php \
            | grep -q "Export parameter required" || exit 1
          echo "✓ Error handling works"

  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build mock server Docker image
        run: |
          docker build -t emlog-mock:test tests/mock/

      - name: Test Docker image
        run: |
          docker run -d --name test-emlog -p 8080:8080 emlog-mock:test
          sleep 3
          curl -f http://localhost:8080/pages/getinformation.php?export\&meterindex=1 \
            | python -m json.tool > /dev/null
          echo "✓ Docker container works correctly"
        timeout-minutes: 2

      - name: Cleanup
        if: always()
        run: |
          docker stop test-emlog 2>/dev/null || true
          docker rm test-emlog 2>/dev/null || true

  manifest-validation:
    name: Manifest Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate manifest.json
        run: |
          python -c "
          import json
          with open('custom_components/emlog/manifest.json') as f:
              manifest = json.load(f)
              
          # Prüfe erforderliche Felder
          required = ['domain', 'name', 'codeowners', 'config_flow', 'documentation', 'version']
          for field in required:
              if field not in manifest:
                  print(f'✗ Missing required field: {field}')
                  exit(1)
          
          print('✓ Manifest has all required fields')
          print(f'✓ Version: {manifest[\"version\"]}')
          print(f'✓ Domain: {manifest[\"domain\"]}')
          "

  import-check:
    name: Import Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check imports
        run: |
          python -c "
          import sys
          import ast
          
          files = [
              'custom_components/emlog/__init__.py',
              'custom_components/emlog/config_flow.py',
              'custom_components/emlog/coordinator.py',
              'custom_components/emlog/sensor.py',
              'custom_components/emlog/template.py',
          ]
          
          for file in files:
              with open(file) as f:
                  try:
                      ast.parse(f.read())
                      print(f'✓ {file}: Syntax OK')
                  except SyntaxError as e:
                      print(f'✗ {file}: Syntax error at line {e.lineno}')
                      print(f'  {e.msg}')
                      sys.exit(1)
          "
